<!-- Copyright(c) 2010 Tom Elam
     Licensed under the terms of the GPL 3.0 license. -->

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <title>Tests of Support for Real-Time, Graphical Editing of DOM Objects</title>
    
    <link id="themeStyles" rel="stylesheet"
	  href="../dojo/dijit/themes/tundra/tundra.css">
      
    <script type="text/javascript"
	    src="../dojo/dojo/dojo.js"></script>
    <script type="text/javascript">
      dojo.require("doh.runner");
      dojo.addOnLoad(function() { doh.register("code.tests.dom-in-edit-mode",
[
{
    name: "1. There is a method to check for DOM Level 2 support of the Events API (fails in Internet Explorer)",
    runTest: function() {
        doh.assertTrue(document.implementation.hasFeature("Events", "2.0"));
    }
},
{
    // See http://developer.mozilla.org/en/DOM/event/Comparison_of_Event_Targets
    // currentTarget: Used to indicate the EventTarget whose
    //     EventListeners are currently being processed. This is
    //     particularly useful during capturing and bubbling.
    // target:
    //     Used to indicate the EventTarget to which the event was
    //     originally dispatched.
    name: "2. Modern browsers allow Events to be synthesized",
    setUp: function() {
	mouseWasClicked = false;
	evt = null;
        var div = dojo.byId('orangeDiv');
	handleMouseClickOnDiv = function(e) {
	    mouseWasClicked = true;
	    evt = e;
	    //doh.assertEqual(div, evt.currentTarget); // Must be tested inside handler!
	};
	// addEventListener does not work in Internet Explorer.
	//document.body.addEventListener('click', handleMouseClickOnDiv, true);
	divConnection = dojo.connect(div, "click", "handleMouseClickOnDiv");

	// simulateEvent - simulate a browser event initiated by the user
	//
	// Modelled after http://blog.pothoven.net/2007/08/synthesizing-events-in-javascript.html .
	simulateEvent = function(eventType, targetElement) {
	    var event;
	    //targetElement = $(targetElement);
	    
	    if (targetElement) {
		// check for IE
		if (window.ActiveXObject) {
		    event = document.createEventObject();
		    targetElement.fireEvent("on"+eventType,event);
		} else {
		    switch (eventType) {
		    case "abort":
		    case "blur":
		    case "change":
		    case "error":
		    case "focus":
		    case "load":
		    case "reset":
		    case "resize":
		    case "scroll":
		    case "select":
		    case "submit":
		    case "unload":
			event = document.createEvent("HTMLEvents");
			event.initEvent(eventType, "true", "true");
			break;
		    case "click":
		    case "mousedown":
		    case "mousemove":
		    case "mouseout":
		    case "mouseover":
		    case "mouseup":
			event = document.createEvent("MouseEvents");
			event.initMouseEvent(eventType, true, true, window,
					     1, 0, 0, 0, 0,
					     false, false, false, false,
					     0, null);
			//event.initMouseEvent(type, canBubble, cancelable, view, 
			//		     detail, screenX, screenY, clientX, clientY, 
			//		     ctrlKey, altKey, shiftKey, metaKey, 
			//		     button, relatedTarget);
			break;
		    }
		    targetElement.dispatchEvent(event);
		}
	    }
	};
    },
    runTest: function() {
        var div = dojo.byId('orangeDiv');
	doh.assertNotEqual('undefined', div);
	simulateEvent("click", div)
        doh.assertTrue(mouseWasClicked);
	doh.assertNotEqual(null, evt);
	doh.assertNotEqual(null, evt.target);
	doh.assertEqual(div, evt.target);
    }
},
{
    // See http://www.w3.org/TR/DOM-Level-2-Events/events.html .
    // Note that "higher in the document tree" means closer to the root, or document.body.
    name: "3. In DOM Level 2's first phase of event handling, the event, including the target, can be captured",
    setUp: function() {
        mouseWasClicked = false;
	evt = null;
	handleMouseClickOnBody = function(e) {
	    mouseWasClicked = true;
	    evt = e;
	    doh.assertEqual(document.body, evt.currentTarget); // Must be tested inside the handler!
	    doh.assertEqual(1, evt.eventPhase); // 1 = capturing phase. Must be tested inside the handler!
	};
	dojo.disconnect(divConnection);
	bodyConnection = dojo.connect(document.body, "click", "handleMouseClickOnBody");
    },
    runTest: function() {
        var div = dojo.byId('orangeDiv');
	doh.assertNotEqual('undefined', div);
	simulateEvent("click", div);
        doh.assertTrue(mouseWasClicked);
	doh.assertNotEqual(null, evt);
	doh.assertNotEqual(null, evt.target);
	doh.assertEqual(div, evt.target);
    }
}
]);
doh.run();
});
    </script>

  </head>
<body class="tundra" style="padding: 50px;">

  <h1 class="testTitle">DOM-in-Edit-Mode Tests</h1>

  <div id="orangeDiv"
       style="width:100px; height:100px; background-color:orange"></div>

</body>
</html>
